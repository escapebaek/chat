<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ</title>
    <style>
      /* CSSÎäî Î≥ÄÍ≤Ω ÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px 0;
      }

      .app-container {
        width: 100%;
        max-width: 400px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .login-screen {
        padding: 40px 30px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .login-screen h1 {
        color: #333;
        margin-bottom: 30px;
        font-size: 24px;
        font-weight: 600;
      }

      .lobby-screen {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .lobby-header {
        text-align: center;
        margin-bottom: 20px;
        padding: 0 10px;
      }

      .lobby-header h2 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 8px;
        word-break: break-all;
      }
      .lobby-header p {
        font-size: 14px;
        color: #666;
      }

      .input-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        color: #666;
        font-size: 14px;
        font-weight: 500;
      }

      .input-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 12px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #666;
        border: 2px solid #e1e5e9;
      }

      .btn-secondary:hover {
        background: #e9ecef;
      }

      .divider {
        display: flex;
        align-items: center;
        margin: 20px 0;
        color: #999;
        font-size: 14px;
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: #e1e5e9;
      }

      .divider span {
        padding: 0 16px;
      }

      .chat-screen {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .room-info h2 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .room-info p {
        font-size: 14px;
        opacity: 0.8;
      }

      .leave-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      }

      .leave-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .messages-container {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
      }

      .message.own {
        align-items: flex-end;
      }

      .message-info {
        font-size: 12px;
        color: #999;
        margin-bottom: 4px;
      }

      .message-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
      }

      .message.own .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 6px;
      }

      .message:not(.own) .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e1e5e9;
        border-bottom-left-radius: 6px;
      }

      .message-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e1e5e9;
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .message-input {
        flex-grow: 1;
        border: 2px solid #e1e5e9;
        border-radius: 20px;
        padding: 12px 16px;
        font-size: 16px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
      }

      .message-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .send-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }

      .send-btn:hover {
        transform: scale(1.05);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .room-list {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .room-item {
        padding: 12px 16px;
        background: #f8f9fa;
        border: 1px solid #e1e5e9;
        border-radius: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .room-item:hover {
        background: #e9ecef;
        transform: translateY(-1px);
      }

      .room-item .room-name {
        font-weight: 600;
        color: #333;
      }

      .room-item .room-users {
        font-size: 12px;
        color: #666;
      }

      .password-protected {
        color: #ffa500;
      }

      .hidden {
        display: none !important;
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 14px;
      }

      .success {
        background: #efe;
        color: #393;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 14px;
      }

      .messages-container::-webkit-scrollbar,
      .room-list::-webkit-scrollbar,
      .lobby-screen::-webkit-scrollbar {
        width: 4px;
      }

      .messages-container::-webkit-scrollbar-track,
      .room-list::-webkit-scrollbar-track,
      .lobby-screen::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb,
      .room-list::-webkit-scrollbar-thumb,
      .lobby-screen::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- ÎãâÎÑ§ÏûÑ ÏûÖÎ†• ÌôîÎ©¥ -->
      <div id="loginScreen" class="login-screen">
        <h1>üí¨ Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ</h1>
        <div class="input-group">
          <label for="username">ÎãâÎÑ§ÏûÑ</label>
          <input
            type="text"
            id="username"
            placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            maxlength="20"
          />
        </div>
        <button class="btn btn-primary" onclick="enterLobby()">
          Î°úÎπÑ ÏûÖÏû•
        </button>
        <div id="loginStatus"></div>
      </div>

      <!-- Î°úÎπÑ ÌôîÎ©¥ (Î∞© Î™©Î°ù Î∞è ÏÉùÏÑ±) -->
      <div id="lobbyScreen" class="lobby-screen hidden">
        <div class="lobby-header">
          <h2 id="welcomeMessage"></h2>
          <p>Ï∞∏Ïó¨Ìï† Î∞©ÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉà Î∞©ÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî.</p>
        </div>

        <!-- Î∞© ÏÉùÏÑ± -->
        <div id="createRoomForm" style="margin-bottom: 20px">
          <div class="input-group">
            <label for="roomName">Î∞© Ïù¥Î¶Ñ</label>
            <input
              type="text"
              id="roomName"
              placeholder="Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              maxlength="30"
            />
          </div>
          <div class="input-group">
            <label for="roomPassword">ÎπÑÎ∞ÄÎ≤àÌò∏ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
            <input
              type="password"
              id="roomPassword"
              placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
            />
          </div>
          <button class="btn btn-primary" onclick="createRoom()">
            ÏÉà Î∞© ÎßåÎì§Í∏∞
          </button>
        </div>

        <div class="divider">
          <span>Í∏∞Ï°¥ Î∞© Ï∞∏Ïó¨</span>
        </div>

        <!-- Î∞© Î™©Î°ù -->
        <div class="room-list" id="roomList">
          <!-- Î∞© Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
        </div>

        <!-- ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• -->
        <div id="passwordForm" class="hidden" style="margin-top: 20px">
          <div class="input-group">
            <label for="joinPassword">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
            <input
              type="password"
              id="joinPassword"
              placeholder="Î∞© ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            />
          </div>
          <button class="btn btn-primary" onclick="joinWithPassword()">
            ÏûÖÏû•
          </button>
          <button class="btn btn-secondary" onclick="hidePasswordForm()">
            Ï∑®ÏÜå
          </button>
        </div>
        <div id="lobbyStatus"></div>
      </div>

      <!-- Ï±ÑÌåÖ ÌôîÎ©¥ -->
      <div id="chatScreen" class="chat-screen hidden">
        <div class="chat-header">
          <div class="room-info">
            <h2 id="currentRoomName">Î∞© Ïù¥Î¶Ñ</h2>
            <p id="onlineUsers">Ï†ëÏÜçÏûê: 1Î™Ö</p>
          </div>
          <button class="leave-btn" onclick="leaveRoom()">ÎÇòÍ∞ÄÍ∏∞</button>
        </div>

        <div class="messages-container" id="messagesContainer">
          <!-- Î©îÏãúÏßÄÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
        </div>

        <div class="message-input-container">
          <textarea
            id="messageInput"
            class="message-input"
            placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
            rows="1"
            onkeydown="handleKeyDown(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Firebase SDK Î™®Îìà Í∞ÄÏ†∏Ïò§Í∏∞
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        onValue,
        set,
        remove,
        serverTimestamp,
        off,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

      // ======================================================================
      // ‚Äª Ï§ëÏöî ‚Äª
      // ÏïÑÎûò firebaseConfig Í∞ùÏ≤¥Î•º Î≥∏Ïù∏Ïùò Firebase ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï Í∞íÏúºÎ°ú ÍµêÏ≤¥ÌïòÏÑ∏Ïöî.
      // Ïù¥Ï†ÑÏóê ÏÇ¨Ïö©Ìïú API ÌÇ§Îäî Ïù¥ÎØ∏ Ïô∏Î∂ÄÏóê ÎÖ∏Ï∂úÎêòÏóàÏúºÎØÄÎ°ú, Î∞òÎìúÏãú ÏÉàÎ°ú Î∞úÍ∏âÎ∞õÏïÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî!
      // ======================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyDpiOVkUB9buK6xsgK8DqDXP_sIZnl9bIk",
        authDomain: "chat-145f6.firebaseapp.com",
        projectId: "chat-145f6",
        storageBucket: "chat-145f6.firebasestorage.app",
        messagingSenderId: "901005677858",
        appId: "1:901005677858:web:39077a07eb61d45d79417b",
        measurementId: "G-M2LPM8VR6F",
        databaseURL:
          "https://chat-145f6-default-rtdb.asia-southeast1.firebasedatabase.app/",
      };

      // Firebase Ï¥àÍ∏∞Ìôî
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // --- Ïù¥Ìïò ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ ÏΩîÎìú ---

      // Ï†ÑÏó≠ Î≥ÄÏàò
      let currentUser = null;
      let currentRoom = null;
      let selectedRoomId = null;

      let roomInfoListener = null;
      let messagesListener = null;
      let roomsListener = null;
      let usersListener = null;

      // ÏÇ¨Ïö©ÏûêÎ™Ö Í≤ÄÏ¶ù
      function validateUsername(username) {
        return (
          username &&
          username.trim().length >= 2 &&
          username.trim().length <= 20
        );
      }

      // Î∞© Ïù¥Î¶Ñ Í≤ÄÏ¶ù
      function validateRoomName(roomName) {
        return (
          roomName &&
          roomName.trim().length >= 2 &&
          roomName.trim().length <= 30
        );
      }

      // ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
      function showMessage(message, type = "error", location = "login") {
        const statusDiv = document.getElementById(
          location === "login" ? "loginStatus" : "lobbyStatus"
        );
        statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
          statusDiv.innerHTML = "";
        }, 3000);
      }

      // Î°úÎπÑ ÏûÖÏû•
      window.enterLobby = function () {
        const username = document.getElementById("username").value.trim();
        if (!validateUsername(username)) {
          showMessage("ÎãâÎÑ§ÏûÑÏùÄ 2-20Í∏ÄÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", "error", "login");
          return;
        }

        currentUser = {
          name: username,
          id: Date.now().toString(),
        };

        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("lobbyScreen").classList.remove("hidden");
        document.getElementById(
          "welcomeMessage"
        ).textContent = `${username}Îãò, ÌôòÏòÅÌï©ÎãàÎã§!`;
        loadRooms();
      };

      // ÎπÑÎ∞ÄÎ≤àÌò∏ Ìèº ÌëúÏãú/Ïà®Í∏∞Í∏∞
      function showPasswordForm() {
        document.getElementById("passwordForm").classList.remove("hidden");
        document.getElementById("createRoomForm").classList.add("hidden");
        document.querySelector(".divider").classList.add("hidden");
        document.getElementById("roomList").classList.add("hidden");
      }

      window.hidePasswordForm = function () {
        document.getElementById("passwordForm").classList.add("hidden");
        document.getElementById("createRoomForm").classList.remove("hidden");
        document.querySelector(".divider").classList.remove("hidden");
        document.getElementById("roomList").classList.remove("hidden");

        document.getElementById("joinPassword").value = "";
        selectedRoomId = null;
      };

      // Î∞© Î™©Î°ù Î°úÎìú (0Î™ÖÏù∏ Î∞© ÏûêÎèô ÏÇ≠Ï†ú Í∏∞Îä• Ï∂îÍ∞Ä)
      function loadRooms() {
        if (roomsListener) roomsListener();

        const roomsRef = ref(database, "rooms");
        roomsListener = onValue(roomsRef, (snapshot) => {
          const rooms = snapshot.val() || {};
          const roomList = document.getElementById("roomList");
          roomList.innerHTML = "";

          Object.keys(rooms).forEach((roomId) => {
            const room = rooms[roomId];

            // 24ÏãúÍ∞Ñ ÏßÄÎÇú Î∞© ÏÇ≠Ï†ú
            const oneDay = 24 * 60 * 60 * 1000;
            if (Date.now() - room.created > oneDay) {
              remove(ref(database, `rooms/${roomId}`));
              return;
            }

            const userCount = room.users ? Object.keys(room.users).length : 0;

            // ‚òÖ Î≥ÄÍ≤ΩÏ†ê: 0Î™ÖÏù∏ Î∞©ÏùÄ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú ÏÇ≠Ï†úÌïòÍ≥† Î™©Î°ùÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            if (userCount === 0) {
              remove(ref(database, `rooms/${roomId}`));
              return; // Îã§Ïùå Î∞©ÏúºÎ°ú ÎÑòÏñ¥Í∞ê
            }

            const roomDiv = document.createElement("div");
            roomDiv.className = "room-item";
            roomDiv.onclick = () => selectRoom(roomId, !!room.password);

            roomDiv.innerHTML = `
                <div>
                    <div class="room-name">
                        ${escapeHtml(room.name)} 
                        ${
                          room.password
                            ? '<span class="password-protected">üîí</span>'
                            : ""
                        }
                    </div>
                    <div class="room-users">${userCount}Î™Ö Ï∞∏Ïó¨Ï§ë</div>
                </div>
            `;

            roomList.appendChild(roomDiv);
          });

          if (
            Object.keys(rooms).length === 0 ||
            roomList.children.length === 0
          ) {
            roomList.innerHTML =
              '<p style="text-align: center; color: #999; padding: 20px;">ÏïÑÏßÅ ÏÉùÏÑ±Îêú Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§. ÏÉà Î∞©ÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>';
          }
        });
      }

      // Î∞© ÏÑ†ÌÉù
      function selectRoom(roomId, hasPassword) {
        selectedRoomId = roomId;
        if (hasPassword) {
          showPasswordForm();
        } else {
          joinRoom(roomId);
        }
      }

      // Î∞© ÏÉùÏÑ±
      window.createRoom = async function () {
        const roomName = document.getElementById("roomName").value.trim();
        const password = document.getElementById("roomPassword").value;

        if (!validateRoomName(roomName)) {
          showMessage("Î∞© Ïù¥Î¶ÑÏùÄ 2-30Í∏ÄÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", "error", "lobby");
          return;
        }

        try {
          const roomsRef = ref(database, "rooms");
          const newRoomRef = push(roomsRef);
          currentRoom = newRoomRef.key;

          const roomData = {
            name: roomName,
            created: serverTimestamp(),
            users: {
              [currentUser.id]: {
                name: currentUser.name,
                joined: serverTimestamp(),
              },
            },
          };

          if (password) {
            roomData.password = password;
          }

          await set(newRoomRef, roomData);
          showChatScreen();
        } catch (error) {
          console.error("Î∞© ÏÉùÏÑ± Ïò§Î•ò:", error);
          showMessage(
            "Î∞© ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Firebase ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.",
            "error",
            "lobby"
          );
        }
      };

      // Î∞© Ï∞∏Ïó¨
      async function joinRoom(roomId, password = null) {
        if (!currentUser) {
          showMessage("ÎãâÎÑ§ÏûÑÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.", "error", "lobby");
          return;
        }

        try {
          const roomRef = ref(database, `rooms/${roomId}`);
          onValue(
            roomRef,
            async (snapshot) => {
              if (!snapshot.exists()) {
                showMessage("Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Î∞©ÏûÖÎãàÎã§.", "error", "lobby");
                return;
              }

              const room = snapshot.val();
              if (room.password && room.password !== password) {
                showMessage("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.", "error", "lobby");
                hidePasswordForm();
                return;
              }

              currentRoom = roomId;

              const userRef = ref(
                database,
                `rooms/${roomId}/users/${currentUser.id}`
              );
              await set(userRef, {
                name: currentUser.name,
                joined: serverTimestamp(),
              });

              showChatScreen();
            },
            { onlyOnce: true }
          );
        } catch (error) {
          console.error("Î∞© Ï∞∏Ïó¨ Ïò§Î•ò:", error);
          showMessage("Î∞© Ï∞∏Ïó¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", "error", "lobby");
        }
      }

      // ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú Î∞© Ï∞∏Ïó¨
      window.joinWithPassword = function () {
        const password = document.getElementById("joinPassword").value;
        if (!password) {
          showMessage("ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", "error", "lobby");
          return;
        }
        joinRoom(selectedRoomId, password);
      };

      // Ï±ÑÌåÖ ÌôîÎ©¥ ÌëúÏãú
      function showChatScreen() {
        document.getElementById("lobbyScreen").classList.add("hidden");
        document.getElementById("chatScreen").classList.remove("hidden");
        if (roomsListener) roomsListener();
        roomsListener = null;

        loadRoomInfo();
        loadMessages();
        loadUsers();
      }

      // Î∞© Ï†ïÎ≥¥ Î°úÎìú
      function loadRoomInfo() {
        if (roomInfoListener) roomInfoListener();
        const roomRef = ref(database, `rooms/${currentRoom}`);
        roomInfoListener = onValue(roomRef, (snapshot) => {
          const room = snapshot.val();
          if (room) {
            document.getElementById("currentRoomName").textContent = escapeHtml(
              room.name
            );
          } else {
            leaveRoom(true);
          }
        });
      }

      // ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú (Í∏∞Ï°¥ 10Ï¥à ÌÉÄÏù¥Î®∏ ÏÇ≠Ï†ú)
      function loadUsers() {
        if (usersListener) usersListener();
        const usersRef = ref(database, `rooms/${currentRoom}/users`);
        usersListener = onValue(usersRef, (snapshot) => {
          const users = snapshot.val() || {};
          const userCount = Object.keys(users).length;
          document.getElementById(
            "onlineUsers"
          ).textContent = `Ï†ëÏÜçÏûê: ${userCount}Î™Ö`;
        });
      }

      // Î©îÏãúÏßÄ Î°úÎìú
      function loadMessages() {
        if (messagesListener) messagesListener();
        const messagesRef = ref(database, `rooms/${currentRoom}/messages`);
        messagesListener = onValue(messagesRef, (snapshot) => {
          const messages = snapshot.val() || {};
          displayMessages(messages);
        });
      }

      // Î©îÏãúÏßÄ ÌëúÏãú
      function displayMessages(messages) {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";

        const messageArray = Object.values(messages).sort(
          (a, b) => a.timestamp - b.timestamp
        );

        messageArray.forEach((message) => {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${
            message.userId === currentUser.id ? "own" : ""
          }`;

          const time = new Date(message.timestamp).toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          });

          messageDiv.innerHTML = `
              <div class="message-info">
                  ${
                    message.userId === currentUser.id
                      ? "ÎÇò"
                      : escapeHtml(message.username)
                  } ‚Ä¢ ${time}
              </div>
              <div class="message-bubble">${escapeHtml(message.text)}</div>
          `;

          container.appendChild(messageDiv);
        });
        container.scrollTop = container.scrollHeight;
      }

      // HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ (XSS Î∞©ÏßÄ)
      function escapeHtml(text) {
        if (typeof text !== "string") return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Î©îÏãúÏßÄ Ï†ÑÏÜ°
      window.sendMessage = async function () {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        try {
          const messagesRef = ref(database, `rooms/${currentRoom}/messages`);
          await push(messagesRef, {
            text: message,
            username: currentUser.name,
            userId: currentUser.id,
            timestamp: serverTimestamp(),
          });
          input.value = "";
          autoResize(input);
        } catch (error) {
          console.error("Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïò§Î•ò:", error);
        }
      };

      // ÌÇ§ ÏûÖÎ†• Ï≤òÎ¶¨
      window.handleKeyDown = function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      };

      // ÌÖçÏä§Ìä∏ÏóêÎ¶¨Ïñ¥ ÏûêÎèô ÌÅ¨Í∏∞ Ï°∞Ï†ï
      window.autoResize = function (textarea) {
        textarea.style.height = "auto";
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
      };

      // Î™®Îì† Ï±ÑÌåÖÎ∞© Í¥ÄÎ†® Î¶¨Ïä§ÎÑàÎ•º Ï†ïÎ¶¨ÌïòÎäî Ìï®Ïàò
      function cleanupChatListeners() {
        if (roomInfoListener) roomInfoListener();
        if (messagesListener) messagesListener();
        if (usersListener) usersListener();
        roomInfoListener = null;
        messagesListener = null;
        usersListener = null;
      }

      // Î∞© ÎÇòÍ∞ÄÍ∏∞ (ÎßàÏßÄÎßâ Ïù∏ÏõêÏù¥Î©¥ Î∞© Ï†ÑÏ≤¥ ÏÇ≠Ï†ú Í∏∞Îä• Ï∂îÍ∞Ä)
      window.leaveRoom = async function (silent = false) {
        if (!currentUser || !currentRoom) return;

        const roomRef = ref(database, `rooms/${currentRoom}`);
        const usersRef = ref(database, `rooms/${currentRoom}/users`);

        try {
          // ‚òÖ Î≥ÄÍ≤ΩÏ†ê: ÎÇòÍ∞ÄÍ∏∞ Ï†Ñ Ïù∏ÏõêÏàò ÌôïÏù∏
          onValue(
            usersRef,
            async (snapshot) => {
              if (snapshot.exists()) {
                const userCount = Object.keys(snapshot.val()).length;
                if (userCount === 1) {
                  // ÎßàÏßÄÎßâ Ïù∏ÏõêÏù¥Î©¥ Î∞© Ï†ÑÏ≤¥Î•º ÏÇ≠Ï†ú
                  await remove(roomRef);
                } else {
                  // ÏïÑÎãàÎ©¥ Î≥∏Ïù∏Îßå ÏÇ≠Ï†ú
                  await remove(
                    ref(
                      database,
                      `rooms/${currentRoom}/users/${currentUser.id}`
                    )
                  );
                }
              }
            },
            { onlyOnce: true }
          );
        } catch (error) {
          console.error("Î∞© ÎÇòÍ∞ÄÍ∏∞ Ïò§Î•ò:", error);
        } finally {
          cleanupChatListeners();

          currentRoom = null;
          selectedRoomId = null;

          document.getElementById("chatScreen").classList.add("hidden");
          document.getElementById("lobbyScreen").classList.remove("hidden");
          hidePasswordForm();
          loadRooms();

          if (!silent) {
            showMessage("Î∞©ÏóêÏÑú ÎÇòÏôîÏäµÎãàÎã§.", "success", "lobby");
          }
        }
      };

      // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£åÏãú Ï†ïÎ¶¨
      window.addEventListener("beforeunload", () => {
        if (currentUser && currentRoom) {
          const userRef = ref(
            database,
            `rooms/${currentRoom}/users/${currentUser.id}`
          );
          remove(userRef);
        }
      });

      // Firebase Ïó∞Í≤∞ ÌôïÏù∏
      try {
        const testRef = ref(database, ".info/connected");
        onValue(testRef, (snapshot) => {
          if (snapshot.val() === true) {
            console.log("FirebaseÏóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.");
          } else {
            console.log("FirebaseÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
          }
        });
      } catch (error) {
        console.log("Firebase ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî:", error.message);
      }
    </script>
  </body>
</html>
