<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <style>
      /* CSSëŠ” ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px 0;
      }

      .app-container {
        width: 100%;
        max-width: 400px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .login-screen {
        padding: 40px 30px;
        text-align: center;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .login-screen h1 {
        color: #333;
        margin-bottom: 30px;
        font-size: 24px;
        font-weight: 600;
      }

      .lobby-screen {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .lobby-header {
        text-align: center;
        margin-bottom: 20px;
        padding: 0 10px;
      }

      .lobby-header h2 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 8px;
        word-break: break-all;
      }
      .lobby-header p {
        font-size: 14px;
        color: #666;
      }

      .input-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        color: #666;
        font-size: 14px;
        font-weight: 500;
      }

      .input-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 12px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 12px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #666;
        border: 2px solid #e1e5e9;
      }

      .btn-secondary:hover {
        background: #e9ecef;
      }

      .divider {
        display: flex;
        align-items: center;
        margin: 20px 0;
        color: #999;
        font-size: 14px;
      }

      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: #e1e5e9;
      }

      .divider span {
        padding: 0 16px;
      }

      .chat-screen {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .room-info h2 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .room-info p {
        font-size: 14px;
        opacity: 0.8;
      }

      .leave-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      }

      .leave-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .messages-container {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
      }

      .message.own {
        align-items: flex-end;
      }

      .message-info {
        font-size: 12px;
        color: #999;
        margin-bottom: 4px;
      }

      .message-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
      }

      .message.own .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 6px;
      }

      .message:not(.own) .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e1e5e9;
        border-bottom-left-radius: 6px;
      }

      .message-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e1e5e9;
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .message-input {
        flex-grow: 1;
        border: 2px solid #e1e5e9;
        border-radius: 20px;
        padding: 12px 16px;
        font-size: 16px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
      }

      .message-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .send-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }

      .send-btn:hover {
        transform: scale(1.05);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .room-list {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .room-item {
        padding: 12px 16px;
        background: #f8f9fa;
        border: 1px solid #e1e5e9;
        border-radius: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .room-item:hover {
        background: #e9ecef;
        transform: translateY(-1px);
      }

      .room-item .room-name {
        font-weight: 600;
        color: #333;
      }

      .room-item .room-users {
        font-size: 12px;
        color: #666;
      }

      .password-protected {
        color: #ffa500;
      }

      .hidden {
        display: none !important;
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 14px;
      }

      .success {
        background: #efe;
        color: #393;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 14px;
      }

      .messages-container::-webkit-scrollbar,
      .room-list::-webkit-scrollbar,
      .lobby-screen::-webkit-scrollbar {
        width: 4px;
      }

      .messages-container::-webkit-scrollbar-track,
      .room-list::-webkit-scrollbar-track,
      .lobby-screen::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb,
      .room-list::-webkit-scrollbar-thumb,
      .lobby-screen::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- ë‹‰ë„¤ì„ ì…ë ¥ í™”ë©´ -->
      <div id="loginScreen" class="login-screen">
        <h1>ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h1>
        <div class="input-group">
          <label for="username">ë‹‰ë„¤ì„</label>
          <input
            type="text"
            id="username"
            placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
            maxlength="20"
          />
        </div>
        <button class="btn btn-primary" onclick="enterLobby()">
          ë¡œë¹„ ì…ì¥
        </button>
        <div id="loginStatus"></div>
      </div>

      <!-- ë¡œë¹„ í™”ë©´ (ë°© ëª©ë¡ ë° ìƒì„±) -->
      <div id="lobbyScreen" class="lobby-screen hidden">
        <div class="lobby-header">
          <h2 id="welcomeMessage"></h2>
          <p>ì°¸ì—¬í•  ë°©ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
        </div>

        <!-- ë°© ìƒì„± -->
        <div id="createRoomForm" style="margin-bottom: 20px">
          <div class="input-group">
            <label for="roomName">ë°© ì´ë¦„</label>
            <input
              type="text"
              id="roomName"
              placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
              maxlength="30"
            />
          </div>
          <div class="input-group">
            <label for="roomPassword">ë¹„ë°€ë²ˆí˜¸ (ì„ íƒì‚¬í•­)</label>
            <input
              type="password"
              id="roomPassword"
              placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"
            />
          </div>
          <button class="btn btn-primary" onclick="createRoom()">
            ìƒˆ ë°© ë§Œë“¤ê¸°
          </button>
        </div>

        <div class="divider">
          <span>ê¸°ì¡´ ë°© ì°¸ì—¬</span>
        </div>

        <!-- ë°© ëª©ë¡ -->
        <div class="room-list" id="roomList">
          <!-- ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
        <div id="passwordForm" class="hidden" style="margin-top: 20px">
          <div class="input-group">
            <label for="joinPassword">ë¹„ë°€ë²ˆí˜¸</label>
            <input
              type="password"
              id="joinPassword"
              placeholder="ë°© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <button class="btn btn-primary" onclick="joinWithPassword()">
            ì…ì¥
          </button>
          <button class="btn btn-secondary" onclick="hidePasswordForm()">
            ì·¨ì†Œ
          </button>
        </div>
        <div id="lobbyStatus"></div>
      </div>

      <!-- ì±„íŒ… í™”ë©´ -->
      <div id="chatScreen" class="chat-screen hidden">
        <div class="chat-header">
          <div class="room-info">
            <h2 id="currentRoomName">ë°© ì´ë¦„</h2>
            <p id="onlineUsers">ì ‘ì†ì: 1ëª…</p>
          </div>
          <button class="leave-btn" onclick="leaveRoom()">ë‚˜ê°€ê¸°</button>
        </div>

        <div class="messages-container" id="messagesContainer">
          <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="message-input-container">
          <textarea
            id="messageInput"
            class="message-input"
            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
            rows="1"
            onkeydown="handleKeyDown(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2 21l21-9L2 3v7l15 2-15 2v7z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Firebase SDK ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸°
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        onValue,
        set,
        remove,
        serverTimestamp,
        off,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

      // ======================================================================
      // â€» ì¤‘ìš” â€»
      // ì•„ë˜ firebaseConfig ê°ì²´ë¥¼ ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì • ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
      // ì´ì „ì— ì‚¬ìš©í•œ API í‚¤ëŠ” ì´ë¯¸ ì™¸ë¶€ì— ë…¸ì¶œë˜ì—ˆìœ¼ë¯€ë¡œ, ë°˜ë“œì‹œ ìƒˆë¡œ ë°œê¸‰ë°›ì•„ ì‚¬ìš©í•˜ì„¸ìš”!
      // ======================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyDpiOVkUB9buK6xsgK8DqDXP_sIZnl9bIk",
        authDomain: "chat-145f6.firebaseapp.com",
        projectId: "chat-145f6",
        storageBucket: "chat-145f6.firebasestorage.app",
        messagingSenderId: "901005677858",
        appId: "1:901005677858:web:39077a07eb61d45d79417b",
        measurementId: "G-M2LPM8VR6F",
        databaseURL:
          "https://chat-145f6-default-rtdb.asia-southeast1.firebasedatabase.app/",
      };

      // Firebase ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // --- ì´í•˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ ---

      // ì „ì—­ ë³€ìˆ˜
      let currentUser = null;
      let currentRoom = null;
      let selectedRoomId = null;

      let roomInfoListener = null;
      let messagesListener = null;
      let roomsListener = null;
      let usersListener = null;

      // ì‚¬ìš©ìëª… ê²€ì¦
      function validateUsername(username) {
        return (
          username &&
          username.trim().length >= 2 &&
          username.trim().length <= 20
        );
      }

      // ë°© ì´ë¦„ ê²€ì¦
      function validateRoomName(roomName) {
        return (
          roomName &&
          roomName.trim().length >= 2 &&
          roomName.trim().length <= 30
        );
      }

      // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      function showMessage(message, type = "error", location = "login") {
        const statusDiv = document.getElementById(
          location === "login" ? "loginStatus" : "lobbyStatus"
        );
        statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
          statusDiv.innerHTML = "";
        }, 3000);
      }

      // ë¡œë¹„ ì…ì¥
      window.enterLobby = function () {
        const username = document.getElementById("username").value.trim();
        if (!validateUsername(username)) {
          showMessage("ë‹‰ë„¤ì„ì€ 2-20ê¸€ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error", "login");
          return;
        }

        currentUser = {
          name: username,
          id: Date.now().toString(),
        };

        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("lobbyScreen").classList.remove("hidden");
        document.getElementById(
          "welcomeMessage"
        ).textContent = `${username}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
        loadRooms();
      };

      // ë¹„ë°€ë²ˆí˜¸ í¼ í‘œì‹œ/ìˆ¨ê¸°ê¸°
      function showPasswordForm() {
        document.getElementById("passwordForm").classList.remove("hidden");
        document.getElementById("createRoomForm").classList.add("hidden");
        document.querySelector(".divider").classList.add("hidden");
        document.getElementById("roomList").classList.add("hidden");
      }

      window.hidePasswordForm = function () {
        document.getElementById("passwordForm").classList.add("hidden");
        document.getElementById("createRoomForm").classList.remove("hidden");
        document.querySelector(".divider").classList.remove("hidden");
        document.getElementById("roomList").classList.remove("hidden");

        document.getElementById("joinPassword").value = "";
        selectedRoomId = null;
      };

      // ë°© ëª©ë¡ ë¡œë“œ (0ëª…ì¸ ë°© ìë™ ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€)
      function loadRooms() {
        if (roomsListener) roomsListener();

        const roomsRef = ref(database, "rooms");
        roomsListener = onValue(roomsRef, (snapshot) => {
          const rooms = snapshot.val() || {};
          const roomList = document.getElementById("roomList");
          roomList.innerHTML = "";

          Object.keys(rooms).forEach((roomId) => {
            const room = rooms[roomId];

            // 24ì‹œê°„ ì§€ë‚œ ë°© ì‚­ì œ
            const oneDay = 24 * 60 * 60 * 1000;
            if (Date.now() - room.created > oneDay) {
              remove(ref(database, `rooms/${roomId}`));
              return;
            }

            const userCount = room.users ? Object.keys(room.users).length : 0;

            // â˜… ë³€ê²½ì : 0ëª…ì¸ ë°©ì€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚­ì œí•˜ê³  ëª©ë¡ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
            if (userCount === 0) {
              remove(ref(database, `rooms/${roomId}`));
              return; // ë‹¤ìŒ ë°©ìœ¼ë¡œ ë„˜ì–´ê°
            }

            const roomDiv = document.createElement("div");
            roomDiv.className = "room-item";
            roomDiv.onclick = () => selectRoom(roomId, !!room.password);

            roomDiv.innerHTML = `
                <div>
                    <div class="room-name">
                        ${escapeHtml(room.name)} 
                        ${
                          room.password
                            ? '<span class="password-protected">ğŸ”’</span>'
                            : ""
                        }
                    </div>
                    <div class="room-users">${userCount}ëª… ì°¸ì—¬ì¤‘</div>
                </div>
            `;

            roomList.appendChild(roomDiv);
          });

          if (
            Object.keys(rooms).length === 0 ||
            roomList.children.length === 0
          ) {
            roomList.innerHTML =
              '<p style="text-align: center; color: #999; padding: 20px;">ì•„ì§ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>';
          }
        });
      }

      // ë°© ì„ íƒ
      function selectRoom(roomId, hasPassword) {
        selectedRoomId = roomId;
        if (hasPassword) {
          showPasswordForm();
        } else {
          joinRoom(roomId);
        }
      }

      // ë°© ìƒì„±
      window.createRoom = async function () {
        const roomName = document.getElementById("roomName").value.trim();
        const password = document.getElementById("roomPassword").value;

        if (!validateRoomName(roomName)) {
          showMessage("ë°© ì´ë¦„ì€ 2-30ê¸€ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error", "lobby");
          return;
        }

        try {
          const roomsRef = ref(database, "rooms");
          const newRoomRef = push(roomsRef);
          currentRoom = newRoomRef.key;

          const roomData = {
            name: roomName,
            created: serverTimestamp(),
            users: {
              [currentUser.id]: {
                name: currentUser.name,
                joined: serverTimestamp(),
              },
            },
          };

          if (password) {
            roomData.password = password;
          }

          await set(newRoomRef, roomData);
          showChatScreen();
        } catch (error) {
          console.error("ë°© ìƒì„± ì˜¤ë¥˜:", error);
          showMessage(
            "ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
            "error",
            "lobby"
          );
        }
      };

      // ë°© ì°¸ì—¬
      async function joinRoom(roomId, password = null) {
        if (!currentUser) {
          showMessage("ë‹‰ë„¤ì„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "error", "lobby");
          return;
        }

        try {
          const roomRef = ref(database, `rooms/${roomId}`);
          onValue(
            roomRef,
            async (snapshot) => {
              if (!snapshot.exists()) {
                showMessage("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.", "error", "lobby");
                return;
              }

              const room = snapshot.val();
              if (room.password && room.password !== password) {
                showMessage("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "error", "lobby");
                hidePasswordForm();
                return;
              }

              currentRoom = roomId;

              const userRef = ref(
                database,
                `rooms/${roomId}/users/${currentUser.id}`
              );
              await set(userRef, {
                name: currentUser.name,
                joined: serverTimestamp(),
              });

              showChatScreen();
            },
            { onlyOnce: true }
          );
        } catch (error) {
          console.error("ë°© ì°¸ì—¬ ì˜¤ë¥˜:", error);
          showMessage("ë°© ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error", "lobby");
        }
      }

      // ë¹„ë°€ë²ˆí˜¸ë¡œ ë°© ì°¸ì—¬
      window.joinWithPassword = function () {
        const password = document.getElementById("joinPassword").value;
        if (!password) {
          showMessage("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error", "lobby");
          return;
        }
        joinRoom(selectedRoomId, password);
      };

      // ì±„íŒ… í™”ë©´ í‘œì‹œ
      function showChatScreen() {
        document.getElementById("lobbyScreen").classList.add("hidden");
        document.getElementById("chatScreen").classList.remove("hidden");
        if (roomsListener) roomsListener();
        roomsListener = null;

        loadRoomInfo();
        loadMessages();
        loadUsers();
      }

      // ë°© ì •ë³´ ë¡œë“œ
      function loadRoomInfo() {
        if (roomInfoListener) roomInfoListener();
        const roomRef = ref(database, `rooms/${currentRoom}`);
        roomInfoListener = onValue(roomRef, (snapshot) => {
          const room = snapshot.val();
          if (room) {
            document.getElementById("currentRoomName").textContent = escapeHtml(
              room.name
            );
          } else {
            leaveRoom(true);
          }
        });
      }

      // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ (ê¸°ì¡´ 10ì´ˆ íƒ€ì´ë¨¸ ì‚­ì œ)
      function loadUsers() {
        if (usersListener) usersListener();
        const usersRef = ref(database, `rooms/${currentRoom}/users`);
        usersListener = onValue(usersRef, (snapshot) => {
          const users = snapshot.val() || {};
          const userCount = Object.keys(users).length;
          document.getElementById(
            "onlineUsers"
          ).textContent = `ì ‘ì†ì: ${userCount}ëª…`;
        });
      }

      // ë©”ì‹œì§€ ë¡œë“œ
      function loadMessages() {
        if (messagesListener) messagesListener();
        const messagesRef = ref(database, `rooms/${currentRoom}/messages`);
        messagesListener = onValue(messagesRef, (snapshot) => {
          const messages = snapshot.val() || {};
          displayMessages(messages);
        });
      }

      // ë©”ì‹œì§€ í‘œì‹œ
      function displayMessages(messages) {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";

        const messageArray = Object.values(messages).sort(
          (a, b) => a.timestamp - b.timestamp
        );

        messageArray.forEach((message) => {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${
            message.userId === currentUser.id ? "own" : ""
          }`;

          const time = new Date(message.timestamp).toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          });

          messageDiv.innerHTML = `
              <div class="message-info">
                  ${
                    message.userId === currentUser.id
                      ? "ë‚˜"
                      : escapeHtml(message.username)
                  } â€¢ ${time}
              </div>
              <div class="message-bubble">${escapeHtml(message.text)}</div>
          `;

          container.appendChild(messageDiv);
        });
        container.scrollTop = container.scrollHeight;
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€)
      function escapeHtml(text) {
        if (typeof text !== "string") return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // ë©”ì‹œì§€ ì „ì†¡
      window.sendMessage = async function () {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        try {
          const messagesRef = ref(database, `rooms/${currentRoom}/messages`);
          await push(messagesRef, {
            text: message,
            username: currentUser.name,
            userId: currentUser.id,
            timestamp: serverTimestamp(),
          });
          input.value = "";
          autoResize(input);
        } catch (error) {
          console.error("ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:", error);
        }
      };

      // í‚¤ ì…ë ¥ ì²˜ë¦¬
      window.handleKeyDown = function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      };

      // í…ìŠ¤íŠ¸ì—ë¦¬ì–´ ìë™ í¬ê¸° ì¡°ì •
      window.autoResize = function (textarea) {
        textarea.style.height = "auto";
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
      };

      // ëª¨ë“  ì±„íŒ…ë°© ê´€ë ¨ ë¦¬ìŠ¤ë„ˆë¥¼ ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜
      function cleanupChatListeners() {
        if (roomInfoListener) roomInfoListener();
        if (messagesListener) messagesListener();
        if (usersListener) usersListener();
        roomInfoListener = null;
        messagesListener = null;
        usersListener = null;
      }

      // ë°© ë‚˜ê°€ê¸° (ë§ˆì§€ë§‰ ì¸ì›ì´ë©´ ë°© ì „ì²´ ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€)
      window.leaveRoom = async function (silent = false) {
        if (!currentUser || !currentRoom) return;

        const roomRef = ref(database, `rooms/${currentRoom}`);
        const usersRef = ref(database, `rooms/${currentRoom}/users`);

        try {
          // â˜… ë³€ê²½ì : ë‚˜ê°€ê¸° ì „ ì¸ì›ìˆ˜ í™•ì¸
          onValue(
            usersRef,
            async (snapshot) => {
              if (snapshot.exists()) {
                const userCount = Object.keys(snapshot.val()).length;
                if (userCount === 1) {
                  // ë§ˆì§€ë§‰ ì¸ì›ì´ë©´ ë°© ì „ì²´ë¥¼ ì‚­ì œ
                  await remove(roomRef);
                } else {
                  // ì•„ë‹ˆë©´ ë³¸ì¸ë§Œ ì‚­ì œ
                  await remove(
                    ref(
                      database,
                      `rooms/${currentRoom}/users/${currentUser.id}`
                    )
                  );
                }
              }
            },
            { onlyOnce: true }
          );
        } catch (error) {
          console.error("ë°© ë‚˜ê°€ê¸° ì˜¤ë¥˜:", error);
        } finally {
          cleanupChatListeners();

          currentRoom = null;
          selectedRoomId = null;

          document.getElementById("chatScreen").classList.add("hidden");
          document.getElementById("lobbyScreen").classList.remove("hidden");
          hidePasswordForm();
          loadRooms();

          if (!silent) {
            showMessage("ë°©ì—ì„œ ë‚˜ì™”ìŠµë‹ˆë‹¤.", "success", "lobby");
          }
        }
      };

      // í˜ì´ì§€ ì¢…ë£Œì‹œ ì •ë¦¬
      window.addEventListener("beforeunload", () => {
        if (currentUser && currentRoom) {
          const userRef = ref(
            database,
            `rooms/${currentRoom}/users/${currentUser.id}`
          );
          remove(userRef);
        }
      });

      // Firebase ì—°ê²° í™•ì¸
      try {
        const testRef = ref(database, ".info/connected");
        onValue(testRef, (snapshot) => {
          if (snapshot.val() === true) {
            console.log("Firebaseì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } else {
            console.log("Firebaseì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        });
      } catch (error) {
        console.log("Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”:", error.message);
      }
    </script>
  </body>
</html>
